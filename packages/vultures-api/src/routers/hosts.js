/*
  Eventually this kind of routers should be 
  autogenerated based on some type of objects
  modeling system. 
*/

import { responseError, response, DefaultData } from "../response.js";
import { getDb } from "../db/index.js";
import { getIps } from "../lib/dns.js";
import { app } from "../app.js";

export const HostsRouter = app()

// /api/v1/hosts
HostsRouter.get("/", async (req, res) => {
  const db = await getDb("host")
  const entries = await db.getAll()
  response(res, { entries }, "Stored hosts")
})

HostsRouter.post("/", async (req, res) => {
  const body = req.body
  if (!body || !body.hostname) {
    return responseError(res, 400, DefaultData, "Bad request")
  }

  const ips = await getIps(body.hostname)
  const db = await getDb("host")
  const insertion = await db.put(body.hostname, { ips, ...body })
  response(res, { entry: insertion }, "Stored hosts")
})

HostsRouter.get("/:hostname", async (req, res) => {
  const hostname = req.params.hostname
  const db = await getDb("host")
  const insertion = await db.get(hostname)
  response(res, { entry: insertion }, "Getted host")
})

HostsRouter.delete("/:hostname", async (req, res) => {
  const hostname = req.params.hostname
  const db = await getDb("host")
  const insertion = await db.delete(hostname)
  response(res, { entry: insertion }, "Delete hosts")
})





